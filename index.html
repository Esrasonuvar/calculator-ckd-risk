<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CKD Mortality Risk (Cox, original units) — 5y & 10y</title>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--skin:#0ea5e9}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--ink)}
  h1{font-size:1.35rem;margin:0 0 10px}
  .card{border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input,select{width:100%;padding:9px 10px;border:1px solid #cbd5e1;border-radius:10px}
  .row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .row-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .row-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .muted{color:var(--muted);font-size:.92rem}
  .btn{background:var(--skin);color:#fff;border:none;border-radius:10px;padding:11px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .tag{display:inline-block;background:#f1f5f9;border:1px solid #e2e8f0;color:var(--ink);padding:3px 8px;border-radius:999px;margin-right:6px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #eef2f7;padding:6px 8px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .big{font-size:1.35rem;font-weight:800}
  .err{color:#dc2626;margin-top:8px;white-space:pre-line}
  .foot{margin-top:10px;color:var(--muted);font-size:.86rem}
  canvas{width:100%;height:300px;border:1px solid #eef2f7;border-radius:8px}
  .horizon{display:flex;gap:10px;align-items:center}
  .horizon label{font-weight:500;margin:0}
</style>
</head>
<body>
<h1>CKD Mortality Risk (Cox)</h1>
<div class="muted">Original‑units Cox models • Two variants: <b>with eGFR</b> and <b>no eGFR</b>. Coding: <b>Sex: 1=male, 2=female</b>. Height(m), Weight(kg), Waist/Hip(cm). Choose 5y or 10y horizon.</div>

<div class="card">
  <div class="row-3">
    <div>
      <label for="model">Model</label>
      <select id="model">
        <option value="with">with eGFR (better performance)</option>
        <option value="noegfr">no eGFR</option>
      </select>
    </div>
    <div>
      <label>Horizon</label>
      <div class="horizon">
        <label><input type="radio" name="hor" value="5"  checked> 5 years</label>
        <label><input type="radio" name="hor" value="10"> 10 years</label>
      </div>
    </div>
    <div>
      <label>&nbsp;</label>
      <span id="tTag"  class="tag">t = 5 years</span>
      <span id="s0tag" class="tag">S₀(5)=—</span>
    </div>
  </div>

  <!-- AGE: ranges -->
  <div class="row" style="margin-top:8px">
    <div>
      <label>Age (choose range)</label>
      <select id="ageRange">
        <option value="28">18–39</option>
        <option value="45">40–49</option>
        <option value="55">50–59</option>
        <option value="65" selected>60–69</option>
        <option value="75">70–79</option>
        <option value="85">80–89</option>
        <option value="92">90+</option>
      </select>
      <div class="muted" id="ageUsedInfo">Using range midpoint: 65</div>
    </div>
    <div>
      <label>Sex</label>
      <select id="sex">
        <option value="1">1 = Male</option>
        <option value="2">2 = Female</option>
      </select>
    </div>
    <div></div>
  </div>

  <div class="row" style="margin-top:4px">
    <div>
      <label>Weight (kg)</label>
      <input id="weight" type="number" step="0.1" min="30" max="250" value="80"/>
      <div class="muted">Allowed: 30–250</div>
    </div>
    <div>
      <label>Height (m)</label>
      <input id="height" type="number" step="0.001" min="1.20" max="2.20" value="1.70"/>
      <div class="muted">Allowed: 1.20–2.20</div>
    </div>
    <div>
      <label>Waist (cm)</label>
      <input id="waist" type="number" step="0.1" min="40" max="200" value="102"/>
      <div class="muted">Allowed: 40–200</div>
    </div>
  </div>

  <div class="row" style="margin-top:4px">
    <div>
      <label>Hip (cm)</label>
      <input id="hip" type="number" step="0.1" min="40" max="200" value="108"/>
      <div class="muted">Allowed: 40–200</div>
    </div>
    <div id="egfrBox">
      <label>eGFR (CKD‑EPI, ml/min/1.73m²)</label>
      <input id="egfr" type="number" step="0.1" min="5" max="180" value="35"/>
      <div class="muted">Allowed: 5–180</div>
    </div>
  </div>

  <div style="margin-top:12px">
    <button class="btn" id="calcBtn">Calculate</button>
    <div id="err" class="err" style="display:none"></div>
  </div>
</div>

<div class="card" id="outCard" style="display:none">
  <div class="row-2">
    <div>
      <div class="muted">Linear predictor (LP)</div>
      <div id="lasi" class="big">—</div>
    </div>
    <div>
      <div class="muted"><span id="sLabel">S(5)</span> &nbsp; / &nbsp; <span id="rLabel">Risk(5)</span></div>
      <div><span id="sVal" class="big">—</span> &nbsp; / &nbsp; <span id="rVal" class="big">—</span></div>
    </div>
  </div>

  <div style="margin-top:14px">
    <div class="muted">Predicted survival (illustrative)</div>
    <canvas id="survPlot" width="900" height="300"></canvas>
  </div>

  <div style="margin-top:14px">
    <div class="muted">Variable contributions (β × x)</div>
    <table id="contribTbl">
      <thead><tr><th>Variable</th><th>value</th><th>β (orig)</th><th>β·x</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="foot">LP = β₀ + Σ(β·x) &nbsp;&nbsp; • &nbsp;&nbsp; S(t)=S₀(t)<sup>exp(LP)</sup> &nbsp;&nbsp; • &nbsp;&nbsp; Risk(t)=1−S(t)</div>
  </div>
</div>

<script>
/* =========================
   ORIGINAL‑UNITS COEFFICIENTS
   =========================
   5y ve 10y için S₀(t) değerlerini buradan yönetiyoruz.
   Not: β katsayıları 5y/10y için aynıdır; ufka göre değişen S0(t)’dir.
   No‑eGFR için S0_5 değerini kendi çıktınızla değiştirin.
*/
const MODELS = {
  noegfr: {
    S0_5 : 0.800000,   // TODO: kendi Python/CSV çıktınızdaki S0(5) ile değiştirin
    S0_10: 0.601333,
    intercept_lp: -2.2278590331754806, // LP'nin zaman-bağımsız sabiti (original-units dosyanızdaki Intercept_LP_tindependent)
    betas: {
      age:    0.03530106321813986,
      sex:   -0.27738658411919054,
      weight:-0.012798914000775506,
      height:-0.024274626226965823,
      waist:  0.022883171612144728,
      hip:   -0.008722279348210944
    }
  },
  with: {
    S0_5 : 0.807858,   // sizden gelen değer
    S0_10: 0.619156,
    intercept_lp: -0.87996775575296188,
    betas: {
      age:    0.03564412979405369,
      sex:   -0.2511488456425562,
      weight:-0.008048629032302246,
      height:-0.05502037088235011,
      waist:  0.019558736457447472,
      hip:   -0.007364391680310238,
      egfr:  -0.02158210481250613
    }
  }
};

const fmt=(x,d=3)=>Number.isFinite(x)?x.toFixed(d):"—";
const pct=(x,d=1)=>Number.isFinite(x)?(100*x).toFixed(d)+"%":"—";

const ageRangeSel=document.getElementById('ageRange');
const ageUsedInfo=document.getElementById('ageUsedInfo');
function getAgeUsed(){ return parseFloat(ageRangeSel.value); }
function updateAgeInfo(){ ageUsedInfo.textContent="Using range midpoint: "+ageRangeSel.value; }
ageRangeSel.addEventListener('change',updateAgeInfo); updateAgeInfo();

const modelSel=document.getElementById('model');
const egfrBox=document.getElementById('egfrBox');
const s0tag=document.getElementById('s0tag');
const tTag=document.getElementById('tTag');
const sLabel=document.getElementById('sLabel');
const rLabel=document.getElementById('rLabel');

function getHorizon(){
  const v=[...document.querySelectorAll('input[name="hor"]')].find(r=>r.checked).value;
  return parseInt(v,10);
}
function refreshUI(){
  const key=modelSel.value, H=getHorizon();
  const cfg=MODELS[key];
  tTag.textContent = `t = ${H} years`;
  s0tag.textContent = H===5 ? `S₀(5)=${cfg.S0_5.toFixed(6)}` : `S₀(10)=${cfg.S0_10.toFixed(6)}`;
  egfrBox.style.display=(key==='with')?'block':'none';
  sLabel.textContent=`S(${H})`;
  rLabel.textContent=`Risk(${H})`;
}
modelSel.addEventListener('change',refreshUI);
document.querySelectorAll('input[name="hor"]').forEach(r=>r.addEventListener('change',refreshUI));
refreshUI();

const errBox=document.getElementById('err');
function mustNum(v,min,max,label){ const n=parseFloat(v); if(!Number.isFinite(n)||n<min||n>max) throw `${label}: ${v} (allowed ${min}–${max})`; return n; }
function getInputs(){
  const age=getAgeUsed();
  const sex=mustNum(document.getElementById('sex').value,1,2,"Sex");
  const weight=mustNum(document.getElementById('weight').value,30,250,"Weight(kg)");
  const height=mustNum(document.getElementById('height').value,1.20,2.20,"Height(m)");
  const waist=mustNum(document.getElementById('waist').value,40,200,"Waist(cm)");
  const hip=mustNum(document.getElementById('hip').value,40,200,"Hip(cm)");
  let egfr=null; if(modelSel.value==='with') egfr=mustNum(document.getElementById('egfr').value,5,180,"eGFR");
  return {age,sex,weight,height,waist,hip,egfr};
}

function compute(modelKey,H,x){
  const cfg=MODELS[modelKey];
  let lp=cfg.intercept_lp;
  Object.entries(cfg.betas).forEach(([k,b])=>{
    const v = (k in x && x[k]!=null) ? x[k] : 0;
    lp += b*v;
  });
  const S0 = (H===5)?cfg.S0_5:cfg.S0_10;
  const S  = Math.pow(S0, Math.exp(lp));
  return {lp, S, risk:1-S};
}

// “broken” survival curve anchored at t=H and S(H)=S
function makeDemoCurve(H,S){
  const T=12, pts=[];
  for(let t=0;t<=T;t++){
    const frac=t/T;
    const base=Math.exp(-2.2*frac);
    const adj = 1 - (1-S)*Math.pow(Math.max(t/H,0),1.3);
    let s=0.65*base + 0.35*adj;
    if(t===0) s=1.0;
    if(t===H) s=S;
    if(t>H) s=Math.max(0.25, S - 0.03*(t-H));
    if(t>0 && t<H && t%2===1) s-=0.02;
    pts.push({t, s:Math.max(0,Math.min(1,s))});
  }
  return pts;
}
function drawPlot(H,S){
  const cvs=document.getElementById('survPlot'), ctx=cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const padL=45,padR=18,padT=16,padB=36, W=cvs.width-padL-padR, Hpx=cvs.height-padT-padB;
  const xs=t=>padL + (t/12)*W, ys=s=>padT + (1-s)*Hpx;
  // axes
  ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,padT+Hpx); ctx.lineTo(padL+W,padT+Hpx); ctx.stroke();
  ctx.fillStyle="#475569"; ctx.font="12px system-ui";
  [1,0.8,0.6,0.4,0.2,0].forEach(v=>{ const yy=ys(v); ctx.strokeStyle="#eef2f7"; ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(padL+W,yy); ctx.stroke(); ctx.fillText(v.toFixed(1),6,yy+4); });
  for(let t=0;t<=12;t+=2){ const xx=xs(t); ctx.fillText(String(t), xx-4, padT+Hpx+18); }
  // vertical t
  ctx.setLineDash([5,6]); ctx.strokeStyle="#9ca3af"; ctx.beginPath(); ctx.moveTo(xs(H),padT); ctx.lineTo(xs(H),padT+Hpx); ctx.stroke(); ctx.setLineDash([]);
  // curve
  const pts=makeDemoCurve(H,S);
  ctx.strokeStyle="#2563eb"; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((p,i)=>{ if(i===0) ctx.moveTo(xs(p.t),ys(p.s)); else ctx.lineTo(xs(p.t),ys(p.s)); }); ctx.stroke();
  // point
  ctx.fillStyle="#1d4ed8"; ctx.beginPath(); ctx.arc(xs(H),ys(S),5,0,2*Math.PI); ctx.fill();
  const lbl = `S(${H})=${S.toFixed(3)}   Risk(${H})=${(1-S).toFixed(3)}`;
  const offX = Math.min(xs(H)-10, padL+W-180);
  ctx.fillStyle="#111827"; ctx.font="13px system-ui";
  ctx.fillText(lbl, Math.max(padL+6, offX-140), ys(S)-12);
}

document.getElementById('calcBtn').addEventListener('click', ()=>{
  errBox.style.display='none';
  try{
    const x=getInputs(); const key=modelSel.value; const H=getHorizon();
    const res=compute(key,H,x);
    document.getElementById('outCard').style.display='block';
    document.getElementById('lasi').textContent=fmt(res.lp,3);
    document.getElementById('sVal').textContent=pct(res.S,1);
    document.getElementById('rVal').textContent=pct(res.risk,1);

    const tbody=document.querySelector('#contribTbl tbody'); tbody.innerHTML='';
    const names={age:'Age (y)',sex:'Sex',weight:'Weight (kg)',height:'Height (m)',waist:'Waist (cm)',hip:'Hip (cm)',egfr:'eGFR'};
    const cfg=MODELS[key]; let sum=cfg.intercept_lp;
    Object.entries(cfg.betas).forEach(([k,b])=>{
      const v=(k in x && x[k]!=null)?x[k]:0; sum+=b*v;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${names[k]||k}</td><td>${fmt(v,3)}</td><td>${fmt(b,6)}</td><td>${fmt(b*v,4)}</td>`;
      tbody.appendChild(tr);
    });

    drawPlot(H,res.S);
  }catch(e){
    errBox.textContent="Please fix the following:\n"+e;
    errBox.style.display='block';
    document.getElementById('outCard').style.display='none';
  }
});
</script>
</body>
</html>
